!function(){var t,e,h,r,i={}.hasOwnProperty,n=function(t,e){function h(){this.constructor=t}for(var r in e)i.call(e,r)&&(t[r]=e[r]);return h.prototype=e.prototype,t.prototype=new h,t.__super__=e.prototype,t};r=ABM.util,ABM.DataSet=e=function(){function e(t,e,h){null==t&&(t=0),null==e&&(e=0),null==h&&(h=[]),this.useNearest=!1,this.reset(t,e,h)}return e.patchDataSet=function(t){var h,r;return new e((r=ABM.patches).numX,r.numY,function(){var e,i,n;for(n=[],e=0,i=r.length;i>e;e++)h=r[e],n.push(h[t]);return n}())},e.importImageDataSet=function(t,e,i){var n;return null==e&&(e=3),n=new h,r.importImage(t,function(t){return n.parse(t),null!=i?i(n):void 0}),n},e.importAscDataSet=function(e,h){var i;return i=new t,r.xhrLoadFile(e,"text",function(t){return i.parse(t),null!=h?h(i):void 0}),i},e.prototype.reset=function(t,e,h){return this.width=t,this.height=e,this.data=h,h.length!==t*e&&r.error("DataSet: data array length error:\ndata.length: "+this.data.length+" width: "+this.width+" height: "+this.height),this},e.prototype.checkXY=function(t,e){return t>=0&&t<=this.width-1&&e>=0&&e<=this.height-1?void 0:r.error("x,y out of range: "+t+","+e)},e.prototype.setSampler=function(t){this.useNearest=t},e.prototype.sample=function(t,e){return this.useNearest?this.nearest(t,e):this.bilinear(t,e)},e.prototype.nearest=function(t,e){return this.getXY(Math.round(t),Math.round(e))},e.prototype.bilinear=function(t,e){var h,r,i,n,a,o,s,u,l,p,c,d,f;return this.checkXY(t,e),l=Math.floor(t),p=Math.floor(e),s=this.toIndex(l,p),u=this.width,t-=l,e-=p,h=1-t,r=1-e,i=this.data[s],n=null!=(c=this.data[s+u])?c:0,a=null!=(d=this.data[++s])?d:0,o=null!=(f=this.data[s+u])?f:0,i*h*r+a*t*r+n*h*e+o*t*e},e.prototype.toIndex=function(t,e){return t+e*this.width},e.prototype.toXY=function(t){return[t%this.width,Math.floor(t/this.width)]},e.prototype.getXY=function(t,e){return this.checkXY(t,e),this.data[this.toIndex(t,e)]},e.prototype.setXY=function(t,e,h){return this.checkXY(t,e),this.data[this.toIndex(t,e)]=h},e.prototype.toString=function(t,e){var h,i,n,a,o;for(null==t&&(t=2),null==e&&(e=", "),n="width: "+this.width+" height: "+this.height+" data:",h=0>t?this.data:r.aToFixed(this.data,t),i=a=0,o=this.height;o>=0?o>a:a>o;i=o>=0?++a:--a)n+="\n"+(""+i+": "+h.slice(i*this.width,(i+1)*this.width));return n.replace(/,/g,e)},e.prototype.toImage=function(t,e,h){var i,n,a,o,s,u,l,p,c,d,f;for(null==t&&(t=!0),null==e&&(e=!0),null==h&&(h=255),i=r.createCtx(this.width,this.height),o=i.getImageData(0,0,this.width,this.height),c=o.data,u=Math.pow(2,t?8:24),l=e?r.normalize(this.data,0,u-1e-6):function(){var t,e,h,i;for(h=this.data,i=[],t=0,e=h.length;e>t;t++)n=h[t],i.push(r.clamp(Math.round(n),0,u-1));return i}.call(this),a=d=0,f=l.length;f>d;a=++d)p=l[a],s=4*a,c[s+3]=h,t?c[s]=c[s+1]=c[s+2]=Math.floor(p):(c[s]=p>>>16,c[s+1]=255&p>>8,c[s+2]=255&p);return i.putImageData(o,0,0),i.canvas},e.prototype.toDrawing=function(t){var e;return null==t&&(t=!0),ABM.patches.installDrawing(e=this.toImage(t)),e},e.prototype.toPatchColors=function(t){var e;return null==t&&(t=!0),ABM.patches.installColors(e=this.toImage(t)),e},e.prototype.toPatchVar=function(t){var h,r;return h=function(){var e,h,i,n;for(i=ABM.patches,n=[],e=0,h=i.length;h>e;e++)r=i[e],n.push(r[t]=this.patchSample(r.x,r.y));return n}.call(this),new e(ABM.patches.numX,ABM.patches.numY,h)},e.prototype.coordSample=function(t,e,h,r,i,n){var a,o;return a=(t-h)*(this.width-1)/i,o=(r-e)*(this.height-1)/n,this.sample(a,o)},e.prototype.patchSample=function(t,e){var h;return h=ABM.world,this.coordSample(t,e,h.minXcor,h.maxYcor,h.numX,h.numY)},e.prototype.resample=function(t,h){var r,i,n,a,o,s,u,l,p;if(t===this.width&&h===this.height)return new e(t,h,this.data);for(r=[],n=(this.width-1)/(t-1),s=(this.height-1)/(h-1),o=l=0;h>l;o=l+=1)for(i=p=0;t>p;i=p+=1)a=i*n,u=o*s,r.push(this.sample(a,u));return new e(t,h,r)},e.prototype.neighborhood=function(t,e,h){var i,n,a,o,s,u;for(null==h&&(h=[]),h.length=0,n=s=-1;1>=s;n=++s)for(i=u=-1;1>=u;i=++u)a=r.clamp(t+i,0,this.width-1),o=r.clamp(e+n,0,this.height-1),h.push(this.data[this.toIndex(a,o)]);return h},e.prototype.convolve=function(t,h){var i,n,a,o,s,u,l,p;for(null==h&&(h=1),i=[],n=[],o=s=0,l=this.height;l>s;o=s+=1)for(a=u=0,p=this.width;p>u;a=u+=1)this.neighborhood(a,o,n),i.push(r.aSum(r.aPairMul(t,n))*h);return new e(this.width,this.height,i)},e.prototype.slopeAndAspect=function(t,h,i){var n,a,o,s,u,l,p,c,d,f,m,g,y;for(null==t&&(t=1),null==h&&(h=!0),null==i&&(i=!1),a=this.convolve([-1,0,1,-2,0,2,-1,0,1],1/8),o=this.convolve([1,2,1,0,0,0,-1,-2,-1],1/8),n=[],p=[],d=f=0,g=this.height;g>f;d=f+=1)for(c=m=0,y=this.width;y>m;c=m+=1){for(s=a.getXY(c,d),u=o.getXY(c,d),p.push(Math.atan(Math.sqrt(s*s+u*u)/t));h&&s===u;)s+=r.randomNormal(0,.01),u+=r.randomNormal(0,.01);l=s===u&&0===u?0/0:Math.atan2(-u,-s),i&&0>l&&(l+=2*Math.PI),n.push(l)}return p=new e(this.width,this.height,p),n=new e(this.width,this.height,n),[p,n,a,o]},e.prototype.subset=function(t,h,i,n){var a,o,s,u,l,p,c;for((t+i>this.width||h+n>this.height)&&r.error("subSet: params out of range"),a=[],s=u=h,p=h+n;p>u;s=u+=1)for(o=l=t,c=t+i;c>l;o=l+=1)a.push(this.getXY(o,s));return new e(i,n,a)},e}(),ABM.AscDataSet=t=function(t){function e(t){this.str=null!=t?t:"",e.__super__.constructor.call(this),0!==this.str.length&&this.parse(this.str)}return n(e,t),e.prototype.parse=function(t){var e,h,r,i,n,a,o,s,u;for(this.str=t,i=t.split("\n"),this.header={},e=n=0;5>=n;e=++n)h=i[e].split(/\s+/),this.header[h[0].toLowerCase()]=parseFloat(h[1]);for(e=a=0,s=this.header.nrows;s>a;e=a+=1){for(r=i[6+e].trim().split(" "),e=o=0,u=r.length;u>=0?u>o:o>u;e=u>=0?++o:--o)r[e]=parseFloat(r[e]);this.data=this.data.concat(r)}return this.reset(this.header.ncols,this.header.nrows,this.data)},e}(e),ABM.ImageDataSet=h=function(t){function e(t,h){this.img=t,this.byteFmt=null!=h?h:3,e.__super__.constructor.call(this),null!=this.img&&this.parse(this.img)}return n(e,t),e.prototype.ByteFmts=[[2],[1,2],[0,1,2],[3,0,1,2]],e.prototype.checkByteFmt=function(){var t;return r.isArray(this.byteFmt)?this.byteFmt.length>4||r.aMax(this.byteFmt)>3||r.aMin(this.byteFmt)<0?r.error("bad ImageDataSet byte format array: "+this.byteFmt):void 0:(1!==(t=this.byteFmt)&&2!==t&&3!==t&&4!==t&&8!==t&&16!==t&&24!==t&&32!==t&&r.error("bad ImageDataSet byte/bit format int: "+this.byteFmt),this.byteFmt>4&&(this.byteFmt=this.byteFmt/8),this.byteFmt=this.ByteFmts[this.byteFmt-1])},e.prototype.parse=function(t){var e,h,i,n,a,o,s,u,l;for(this.img=t,this.checkByteFmt(this.byteFmt),this.ctx=r.imageToCtx(this.img),i=r.ctxToImageData(this.ctx).data,e=a=0,u=i.length;u>a;e=a+=4){for(n=0,l=this.byteFmt,o=0,s=l.length;s>o;o++)h=l[o],n=256*n+i[e+h];this.data.push(n)}return this.reset(this.ctx.canvas.width,this.ctx.canvas.height,this.data)},e}(e)}.call(this);